import os
from elasticsearch import Elasticsearch

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
ELASTIC_HOST = "http://localhost:9200"
ELASTIC_USER = "elastic"
ELASTIC_PASSWORD = "your_password"

es = Elasticsearch(ELASTIC_HOST, basic_auth=(ELASTIC_USER, ELASTIC_PASSWORD))

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
scroll_size = 1000
index_name = "your_index_name"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∏–Ω–¥–µ–∫—Å
if not es.indices.exists(index=index_name):
    print(f"‚ö†Ô∏è –ò–Ω–¥–µ–∫—Å '{index_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é...")
    es.indices.create(index=index_name)
    print(f"‚úÖ –ò–Ω–¥–µ–∫—Å '{index_name}' —Å–æ–∑–¥–∞–Ω.")

# –ü–æ–∏—Å–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º scroll –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ 'TargetUserName' –∏–ª–∏ 'SubjectUserName'
query = {
    "size": scroll_size,
    "query": {
        "should":[
            {"term":{"TargetUserName":"sa"}},
            {"term":{"SubjectUserName":"sa"}}
        ]
    }
}

response = es.search(index=index_name, body=query, scroll="2m")

# –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ª–æ–≥–∏
try:
    subject_user_file_exists = os.path.exists("SubjectUserName.txt")
    target_user_file_exists = os.path.exists("TargetUserName.txt")

    # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–ø–∏—Å–∏
    with open("SubjectUserName.txt", "a" if subject_user_file_exists else "w", encoding="utf-8") as subject_file, \
         open("TargetUserName.txt", "a" if target_user_file_exists else "w", encoding="utf-8") as target_file:

        if not subject_user_file_exists:
            subject_file.write("1\n")
        if not target_user_file_exists:
            target_file.write("1\n")

        scroll_id = response["_scroll_id"]
        total_hits = response["hits"]["total"]["value"]
        print(f"üîç –ù–∞–π–¥–µ–Ω–æ {total_hits} –∑–∞–ø–∏—Å–µ–π —Å TargetUserName='sa' –∏–ª–∏ SubjectUserName='sa', –Ω–∞—á–∏–Ω–∞—é —ç–∫—Å–ø–æ—Ä—Ç...")

        while len(response["hits"]["hits"]) > 0:
            for hit in response["hits"]["hits"]:
                subject_username = hit["_source"].get("SubjectUserName", "")
                target_username = hit["_source"].get("TargetUserName", "")

                # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ SubjectUserName –∏ TargetUserName
                if subject_username == "sa":
                    subject_file.write(f"{hit}\n")
                if target_username == "sa":
                    target_file.write(f"{hit}\n")

            # –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫—É—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö
            response = es.scroll(scroll_id=scroll_id, scroll="2m")
            scroll_id = response["_scroll_id"]

        print(f"‚úÖ –õ–æ–≥–∏ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ —Ñ–∞–π–ª—ã SubjectUserName.txt –∏ TargetUserName.txt")

except IOError as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–∞–π–ª–∞–º–∏: {e}")
