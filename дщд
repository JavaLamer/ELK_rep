from elasticsearch import Elasticsearch

ELASTIC_HOST = "http://localhost:9200"
ELASTIC_USER = "elastic"
ELASTIC_PASSWORD = "your_password"

es = Elasticsearch(ELASTIC_HOST, basic_auth=(ELASTIC_USER, ELASTIC_PASSWORD))

index_name = "your_index_name"
size = 1000  # Количество документов за раз

query = {
    "_source": ["host.name", "winlogon.event_data.SubjectUserName"],
    "query": {"term": {"winlogon.event_data.SubjectUserName": "sa"}},
    "sort": [{"_id": "asc"}]  # Поле сортировки (можно заменить)
}

all_hosts = set()
last_sort_value = None

while True:
    if last_sort_value:
        query["search_after"] = last_sort_value

    response = es.search(index=index_name, body=query, size=size)

    hits = response["hits"]["hits"]
    if not hits:
        break

    for hit in hits:
        host_name = hit["_source"].get("host", {}).get("name")
        if host_name:
            all_hosts.add(host_name)

    last_sort_value = hits[-1]["sort"]

# Записываем уникальные хосты в файл
with open("logs.txt", "w") as file:
    file.writelines(f"{host}\n" for host in all_hosts)

print(f"✅ Собрано {len(all_hosts)} уникальных хостов")
